// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  MANAGER
  CLEANER
}

enum TaskStatus {
  PENDING_REVIEW
  APPROVED
  DENIED
  PAID
}

enum TransactionStatus {
  PENDING
  CHARGED
  APPROVED
  PAID
  FAILED
  REFUNDED
}

enum InvoiceType {
  CLIENT
  CLEANER
  INTERNAL
}

model User {
  id                       String  @id @default(cuid())
  email                    String  @unique
  name                     String
  passwordHash             String? @map("password_hash")
  role                     Role
  stripeConnectedAccountId String? @map("stripe_connected_account_id")

  inviteToken       String?   @unique @map("invite_token")
  inviteTokenExpiry DateTime? @map("invite_token_expiry")
  invitedAt         DateTime? @map("invited_at")

  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tasksAsCleaner        Task[]        @relation("CleanerTasks")
  transactionsAsCleaner Transaction[] @relation("CleanerTransactions")
  transactionsAsManager Transaction[] @relation("ManagerTransactions")
  approvedTransactions  Transaction[] @relation("ApprovedTransactions")
manualInvoicesManaged ManualInvoice[] @relation("InvoicesToManagers")
manualInvoicesReceived ManualInvoice[] @relation("InvoicesToCleaners")
  @@map("users")
}

model Task {
  id           String     @id @default(cuid())
  guestyTaskId String     @unique @map("guesty_task_id")
  propertyName String     @map("property_name")
  cleanerId    String?    @map("cleaner_id")
  status       TaskStatus @default(PENDING_REVIEW)
  completedAt  DateTime?  @map("completed_at")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  cleaner      User?         @relation("CleanerTasks", fields: [cleanerId], references: [id])
  transactions Transaction[]

  @@map("tasks")
}

model Transaction {
  id          String            @id @default(cuid())
  amount      Float // Total client charge
  description String?
  status      TransactionStatus @default(PENDING)

  // Payment breakdown
  cleanerPayout   Float?  @map("cleaner_payout")
  platformFee     Float?  @map("platform_fee")
  platformFeeType String? @default("AUTO_20_PERCENT") @map("platform_fee_type")

  // Legacy fields (from old system)
  guestName   String?  @map("guest_name")
  cleanerFee  Decimal? @map("cleaner_fee") @db.Decimal(10, 2)
  guestCharge Decimal? @map("guest_charge") @db.Decimal(10, 2)
  notes       String?

  // Stripe fields
  stripePaymentIntentId String? @unique @map("stripe_payment_intent_id")
  stripeChargeId        String? @map("stripe_charge_id")
  stripeTransferId      String? @map("stripe_transfer_id")
  stripeFee             Float?  @map("stripe_fee")
  netAmount             Float?  @map("net_amount")

  // Relations
  clientId String? @map("client_id")
  client   Client? @relation("ClientTransactions", fields: [clientId], references: [id])

  cleanerId String? @map("cleaner_id")
  cleaner   User?   @relation("CleanerTransactions", fields: [cleanerId], references: [id])

  managerId String @map("manager_id")
  manager   User   @relation("ManagerTransactions", fields: [managerId], references: [id])

  taskId String? @unique @map("task_id")
  task   Task?   @relation(fields: [taskId], references: [id])

  approvedBy String? @map("approved_by")
  approver   User?   @relation("ApprovedTransactions", fields: [approvedBy], references: [id])

  // Timestamps
  approvedAt DateTime? @map("approved_at")
  paidAt     DateTime? @map("paid_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  invoices Invoice[]

  @@map("transactions")
}

model Client {
  id                     String   @id @default(cuid())
  name                   String
  email                  String   @unique
  phone                  String?
  address                String?
  stripeCustomerId       String?  @unique @map("stripe_customer_id")
  defaultPaymentMethodId String?  @map("default_payment_method_id")
  guestyGuestId          String?  @unique @map("guesty_guest_id")
  createdAt              DateTime @default(now()) @map("created_at")
  updatedAt              DateTime @updatedAt @map("updated_at")
  transactions Transaction[] @relation("ClientTransactions")
manualInvoices   ManualInvoice[]

  @@map("clients")
}

model Invoice {
  id             String      @id @default(cuid())
  invoiceNumber  String      @unique @map("invoice_number")
  type           InvoiceType
  transactionId  String      @map("transaction_id")
  recipientEmail String      @map("recipient_email")
  recipientName  String      @map("recipient_name")
  amount         Decimal     @db.Decimal(10, 2)
  pdfUrl         String?     @map("pdf_url")
  sentAt         DateTime?   @map("sent_at")
  createdAt      DateTime    @default(now()) @map("created_at")

  transaction Transaction @relation(fields: [transactionId], references: [id])

  @@map("invoices")
}

model InvitationToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  used      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  @@map("invitation_tokens")
}

model ManualInvoice {
  id              String   @id @default(cuid())
  invoiceNumber   String   @unique
  status          String
  issueDate       DateTime @default(now())
  dueDate         DateTime
  
  subtotal        Float
  tax             Float    @default(0)
  discount        Float    @default(0)
  total           Float
  
recipientType   String   @default("CLIENT")
  
  clientId        String?
  client          Client?  @relation(fields: [clientId], references: [id])
  
  cleanerUserId   String?
  cleanerUser     User?    @relation("InvoicesToCleaners", fields: [cleanerUserId], references: [id])
  
  lineItems       Json
  
  notes           String?
  terms           String?
  
  paidAt          DateTime?
  paidAmount      Float    @default(0)
  
  managerId       String
  manager         User     @relation("InvoicesToManagers", fields: [managerId], references: [id])
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}
